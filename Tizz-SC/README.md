# Tizz Protocol Smart Contracts

The Tizz Protocol's smart contract system is designed to facilitate a variety of operations including trading, referrals, NFT design, and more. Below is an overview of the key components and functionalities within the codebase.

## Contracts Overview

### Tizz Finance Protocol Tokens

-   `TizzFinanceToken`:
    This is Tizz Finance Utility Token.
    It acts as a mechanism of liquidity efficiency which helps `Tizz Finance` capitalise on our resources and offer the best trading experience - as well as returns for those participating in the ecosystem.
-   `TizTokenLockedDepositNft`:
    Generates token URIs for NFTs representing locked deposits, including SVG image encoding.
-   `TizzTokenLockedDepositNftDesign`:
    Interface for the NFT design contract.

### Core Contracts

-   `TizzMultiCollatDiamond`:
    Contains most of information for trading.
    It acts in the form of a partial contract to provide conditional status for trading. (Fees, Referrals, Pair Information, PriceImpact, permission)
-   `TizzStaking`:
    Provides rewards that generated by platform fees to traders who staked `TizzFinanceToken` to staking contract.
    For now, $USDT, $WBTC, $BTC(native token) are supported as rewards token.

#### Libraries

-   `FeeTierUtils`:
    Handles fee tier calculations based on trader activity.
-   `PairStorageUtils`:
    Manages trading pairs, groups, and fee structures within the system.
-   `PriceImpactUtils`:
    Manages price impact calculations and open interest window settings.
-   `ReferralsUtils`:
    Handles the referral system logic, including fee calculations, reward distribution, and ally/referrer management.

### Admin Contracts

-   `TizzTimelockManager`:
    Contract that apply lock tokens for the exact duration to avoid sudden price fluctuations and ensure the liquidity pool.

### Tizz Collateral Contracts

-   `TizzTradingStorage`:
    Stores trade-related data, including open interest, order counts, and fee information.
-   `TizzBorrowingFees`:
    Stores fee information and calculates fee amount when close or liquidate trading orders.
-   `TizzPriceAggregator`:
    Provides exact price information for tokens and affect to trading directly whenever traders open/trade/liquidate trading orders.
    Calculate price impact and provides/applies loss/profit to traders orders.
    Inteacts with TizzTradingStorage and TizzMultiCollatDiamond directly.
-   `TizzTradingPriceFeedManager`:
    Manages OpenPnl oracle requests for Tizz Trading.
-   `TizzTrading`:
    Manages trading operations, ensuring trades adhere to system constraints like leverage limits and price impact.
-   `TizzTradingCallbacks`:
    Regarding traders orders, store/remove orders and apply/calculate profit/loss to orders.
-   `TizzVaultToken`:
    This is Tizz Finacen Vault contract interacts with trading directly.

#### Libraries

-   `BorrowingFeeUtils`:
    Provides mechanism to calculate borrowing fees for traders orders.
-   `PackingUtils`:
    Offers functions for packing and unpacking data into.
-   `TradeUtils`:
    By interacting with TizzTradingCallbacks contract, checks/stores/updates traders orders.
-   `TradingCallbackUtils`:
    Stores/updates trading orders by calculating price impact and platform/borrowing fees.

## Events Overview

### TizzBorrowingFees

-   `PairGroupUpdated`:
    Emitted when a pair's borrowing group has been updated.
-   `PairParamsUpdated`:
    Emitted when a pair's borrowing params is updated.
-   `GroupUpdated`:
    Emitted when a group's borrowing params is updated.
-   `GroupOiUpdated`:
    Emitted when a borrowing group's open interests are updated.
-   `PairAccFeesUpdated`:
    Emitted when a pair's borrowing acc fees are updated.
-   `GroupAccFeesUpdated`:
    Emitted when a group's borrowing acc fees are update.
-   `TradeInitialAccFeesStored`:
    Emitted when a trade's initial acc borrowing fees are stored.
-   `TradeActionHandled`:
    Emitted when a trade is executed and borrowing callback is handled.

### TizzPriceAggregator

-   `CollateralPriceIdUpdated`:
    Emitted when collateral pair id is updated.
-   `SupraOracleUpdated`:
    Emitted when supra oracle pull address is updated.
-   `SupraOracleStorageUpdated`:
    Emitted when supra oracle storage address is updated.
-   `CallbackExecuted`:
    Emitted when a trading callback is called from the price aggregator.
-   `PriceReceived`:
    Emitted when a price is received from the supra oracle.

### TizzVaultToken

-   `OpenTradesPnlFeedCallFailed`:
    Emitted when newOpenPnlRequestOrEpoch call failed.
-   `AccBlockWeightedMarketCapStored`:
    Emitted when accBlockWeightedMarketCap is updated.
-   `ShareToAssetsPriceUpdated`:
    Emitted when rate between share and assetPrice is updated.
-   `WithdrawRequested`:
    Emitted when request for withdrawal is submitted.
-   `WithdrawCanceled`:
    Emitted when submitted withdrawal request is canceled.
-   `DepositLocked`:
    Emitted when users deposited assets and it's locked for the duration.
-   `DepositUnlocked`:
    Emitted when users deposited assets are unlocked and transferred to users.
-   `RewardDistributed`:
    Emitted when updates rewards rate by depositing assets from fees of traders orders.
-   `Depleted`:
    Emitted when traders get back their assets by burning TizzVaultToken(shares).
-   `Refilled`:
    Emitted when traders get TizzVaultToken(shares) by re-depositing assets.

### TizzTradingPriceFeedManager

-   `NextEpochValuesReset`:
    Emitted when reset current epoch information.
-   `NewEpochForced`:
    Emitted when make new epoch manually.
-   `NewEpoch`:
    Emitted when make new epoch.
-   `RequestMedianValueSet`:
    Emitted when updates price for current epoch by averaging new prices.

### TizzTrading

-   `OpenLimitPlaced`:
    Emitted when traders submit limit trading orders.
-   `MarketOrderInitiated`:
    Emitted when traders submit MARKET trading orders.
-   `OpenLimitUpdated`:
    Emitted when traders updates information with their submitted trading orders.
-   `TpUpdated`:
    Emitted when traders updates Tp(take profit) value.
-   `SlUpdated`:
    Emitted when traders updates Sl(stop loss) value.
-   `NftOrderInitiated`:
    Emitted when traders submit Nft trading order.

### TizzTradingCallbacks

-   `GovFeesClaimed`:
    Emitted when traders claim governance fees.
-   `MarketExecuted`:
    Emitted when traders submits market orders without any issue.
-   `MarketOpenCanceled`:
    Emitted when traders submits market orders but it's canceled due to changes in market conditions or incorrect trade inputs.
-   `MarketCloseCanceled`:
    Emitted when traders requests to close their open trades but it's canceled due to changes in market conditions or incorrect trade inputs.
-   `LimitExecuted`:
    Emitted when a limit/stop order is executed.
-   `NftOrderCanceled`:
    Emitted when a limit/stop order is canceled due to changes in market conditions or incorrect trade inputs.

## Security Considerations

The contracts employ various security measures such as role-based access control, input validation, and reentrancy guards. It is crucial to thoroughly test and audit all smart contracts before deploying them to a production environment to ensure the security and integrity of the system.

## Development and Deployment

The contracts are designed with upgradeability in mind, using proxies and the OpenZeppelin upgradeable contracts framework. This allows for future improvements and fixes to be deployed without disrupting the existing ecosystem.

## Conclusion

The Tizz Protocol's smart contract system provides a robust foundation for trading, referrals, NFTs, and price aggregation within the DeFi space. The modular design and comprehensive feature set enable a wide range of functionalities while maintaining security and upgradeability.
